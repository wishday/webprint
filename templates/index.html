<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webæ‰“å°æœåŠ¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ–¨ï¸ Webæ‰“å°æœåŠ¡</h1>
            <p class="text-gray-600">åŸºäºCUPSçš„ç½‘ç»œæ‰“å°è§£å†³æ–¹æ¡ˆ</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦ä¾§ï¼šé¢„è§ˆå’Œä¸Šä¼  -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“ æ–‡ä»¶é¢„è§ˆä¸ä¸Šä¼ </h2>
                    
                    <div id="uploadPreviewContainer" class="upload-area rounded-lg overflow-hidden relative" style="min-height: 450px;">
                        <!-- ä¸Šä¼ çŠ¶æ€ -->
                        <div id="uploadState" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer p-8">
                            <svg class="h-20 w-20 text-gray-300 mb-4" fill="none" viewBox="0 0 48 48" stroke="currentColor">
                                <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"/>
                            </svg>
                            <p class="text-lg font-medium text-gray-600 mb-2">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
                            <p class="text-sm text-gray-400 mb-4">æ”¯æŒ PDFã€å›¾ç‰‡ç­‰æ ¼å¼ (æœ€å¤§ 100MB)</p>
                            <label for="fileInput" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg cursor-pointer">
                                é€‰æ‹©æ–‡ä»¶
                            </label>
                        </div>

                        <!-- é¢„è§ˆçŠ¶æ€ -->
                        <div id="previewState" class="absolute inset-0 hidden">
                            <div class="bg-gray-800 text-white px-4 py-3 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span id="previewFileName"></span>
                                    <span id="previewFileSize" class="text-xs text-gray-400"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="fileInput" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded cursor-pointer">
                                        æ›´æ¢
                                    </label>
                                    <button id="removeFile" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded">
                                        ç§»é™¤
                                    </button>
                                </div>
                            </div>
                            <div id="previewContent" class="bg-gray-50 p-2 relative" style="height: 400px;"></div>
                        </div>

                        <input type="file" id="fileInput" style="display:none;">
                    </div>
                </div>

                <!-- æ‰“å°è®¾ç½® -->
                <div class="bg-white rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">âš™ï¸ æ‰“å°è®¾ç½®</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©æ‰“å°æœº</label>
                        <select id="printerSelect" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çº¸å¼ å¤§å°</label>
                            <select id="paperSize" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                                <option value="A4" selected>A4 (210Ã—297mm)</option>
                                <option value="A3">A3 (297Ã—420mm)</option>
                                <option value="A2">A2 (420Ã—594mm)</option>
                                <option value="A1">A1 (594Ã—841mm)</option>
                                <option value="5inch">5å¯¸ (89Ã—127mm)</option>
                                <option value="6inch">6å¯¸ (102Ã—152mm)</option>
                                <option value="7inch">7å¯¸ (127Ã—178mm)</option>
                                <option value="8inch">8å¯¸ (152Ã—203mm)</option>
                                <option value="10inch">10å¯¸ (203Ã—254mm)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">çº¸å¼ æè´¨</label>
                            <select id="paperType" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                                <option value="plain" selected>æ™®é€šçº¸</option>
                                <option value="glossy">å…‰é¢ç…§ç‰‡çº¸</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è‰²å½©æ¨¡å¼</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <input type="radio" name="colorMode" value="color" class="mr-3">
                                    <svg class="w-5 h-5 mr-2 text-blue-500" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10" fill="red"/>
                                        <circle cx="6" cy="18" r="10" fill="green"/>
                                        <circle cx="18" cy="18" r="10" fill="blue"/>
                                    </svg>
                                    <span>å½©è‰²</span>
                                </label>
                                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <input type="radio" name="colorMode" value="mono" checked class="mr-3">
                                    <svg class="w-5 h-5 mr-2 text-gray-700" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="12" r="10"/>
                                    </svg>
                                    <span>é»‘ç™½</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åŒé¢æ‰“å°</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <input type="radio" name="duplex" value="one-sided" class="mr-3">
                                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span>å•é¢</span>
                                </label>
                                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <input type="radio" name="duplex" value="two-sided-long-edge" checked class="mr-3">
                                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <!-- é•¿æ–¹å½¢A4çº¸è½®å»“ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 3h16v18H4z"/>
                                        <!-- æ–‡å­—æ¨ªçº¿ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 8h12M6 12h10"/>
                                        <!-- å·¦æ–¹é•¿è¾¹è™šçº¿ï¼ˆå¾€å³ç§»ä¸€ç‚¹ï¼‰ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M0.5 3v18" stroke-dasharray="4 2"/>
                                    </svg>
                                    <span>åŒé¢(é•¿è¾¹ç¿»é¡µ)</span>
                                </label>
                                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <input type="radio" name="duplex" value="two-sided-short-edge" class="mr-3">
                                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                                        <!-- é•¿æ–¹å½¢A4çº¸è½®å»“ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 3h16v18H4z"/>
                                        <!-- æ–‡å­—æ¨ªçº¿ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 8h12M6 12h10"/>
                                        <!-- ä¸Šæ–¹çŸ­è¾¹è™šçº¿ï¼ˆå¾€ä¸‹ç§»ä¸€ç‚¹ï¼‰ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M0 1.5h24" stroke-dasharray="4 2"/>
                                    </svg>
                                    <span>åŒé¢(çŸ­è¾¹ç¿»é¡µ)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰“å°æ–¹å‘</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <input type="radio" name="orientation" value="portrait" checked class="mr-3">
                                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <span>çºµå‘æ‰“å°</span>
                                </label>
                                <label class="flex items-center p-2 border rounded-lg hover:bg-gray-50 cursor-pointer transition">
                                    <input type="radio" name="orientation" value="landscape" class="mr-3">
                                    <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <!-- æ¨ªå‘A4çº¸å¤–æ¡†ï¼ˆé«˜åº¦å‹æ‰ï¼‰ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 6h20v12H2z"/>
                                        <!-- æ¨ªå‘æ–‡å­—ç¤ºæ„ï¼ˆ2æ¡çº¿ï¼‰ -->
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 9h16M4 13h14"/>
                                    </svg>
                                    <span>æ¨ªå‘æ‰“å°</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‰“å°ä»½æ•°</label>
                            <input type="number" id="copies" value="1" min="1" max="100" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¡µé¢èŒƒå›´</label>
                        <input type="text" id="pageRange" placeholder="ä¾‹å¦‚: 1-5,8,10-12" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                    </div>

                    <button id="printBtn" disabled class="w-full bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg">
                        ğŸ–¨ï¸ æäº¤æ‰“å°
                    </button>

                    <!-- æ‰“å°å‚æ•°è¯¦æƒ… -->
                    <div id="printParamsSection" class="mt-4 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                            </svg>
                            æ‰“å°å‚æ•°è¯¦æƒ…
                        </h3>
                        <div id="printParamsContent" class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
                            <!-- å‚æ•°å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ–‡ä»¶åˆ—è¡¨å’Œæ‰“å°ä»»åŠ¡ -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸ“ å·²ä¸Šä¼ æ–‡ä»¶</h2>
                        <button id="refreshFiles" class="text-sm text-blue-500 hover:text-blue-700">åˆ·æ–°</button>
                    </div>
                    <div id="filesList" class="space-y-2 max-h-80 overflow-y-auto">
                        <p class="text-gray-500 text-sm text-center py-4">åŠ è½½ä¸­...</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">ğŸ“‹ æ‰“å°ä»»åŠ¡</h2>
                        <button id="refreshQueue" class="text-sm text-blue-500 hover:text-blue-700">åˆ·æ–°</button>
                    </div>
                    <div id="jobsList" class="space-y-2 max-h-80 overflow-y-auto">
                        <p class="text-gray-500 text-sm text-center py-4">åŠ è½½ä¸­...</p>
                    </div>
                    
                    <!-- æ‰“å°æœºé˜Ÿåˆ—ä¿¡æ¯ -->
                    <div id="printerQueueSection" class="mt-4 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            æ‰“å°æœºé˜Ÿåˆ—ä¿¡æ¯
                        </h3>
                        <div id="printerQueueInfo" class="bg-gray-50 rounded-lg p-3 text-sm">
                            <p class="text-gray-500 text-center">è¯·å…ˆé€‰æ‹©æ‰“å°æœº</p>
                        </div>
                    </div>

                    <!-- çº¸ç›’ä¿¡æ¯ -->
                    <div id="printerTraySection" class="mt-4 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                            </svg>
                            çº¸ç›’ä¿¡æ¯
                        </h3>
                        <div id="printerTrayInfo" class="bg-gray-50 rounded-lg p-3 text-sm">
                            <p class="text-gray-500 text-center">è¯·å…ˆé€‰æ‹©æ‰“å°æœº</p>
                        </div>
                    </div>

                    <!-- å¢¨ç›’ä¿¡æ¯ -->
                    <div id="printerInkSection" class="mt-4 pt-4 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                            </svg>
                            å¢¨ç›’ä¿¡æ¯
                        </h3>
                        <div id="printerInkInfo" class="bg-gray-50 rounded-lg p-3 text-sm">
                            <p class="text-gray-500 text-center">è¯·å…ˆé€‰æ‹©æ‰“å°æœº</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg hidden"></div>

    <script>
        let uploadedFile = null;
        let jobs = [];
        let pdfSupport = null;

        document.addEventListener('DOMContentLoaded', () => {
            // è·å–DOMå…ƒç´ 
            const uploadPreviewContainer = document.getElementById('uploadPreviewContainer');
            const uploadState = document.getElementById('uploadState');
            const previewState = document.getElementById('previewState');
            const fileInput = document.getElementById('fileInput');
            const removeFileBtn = document.getElementById('removeFile');
            const printBtn = document.getElementById('printBtn');
            const refreshFilesBtn = document.getElementById('refreshFiles');
            const refreshQueueBtn = document.getElementById('refreshQueue');

            // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFile(e.target.files[0]);
                    }
                });
            }

            // æ‹–æ‹½äº‹ä»¶
            if (uploadPreviewContainer) {
                uploadPreviewContainer.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadPreviewContainer.classList.add('dragover');
                });
                uploadPreviewContainer.addEventListener('dragleave', () => {
                    uploadPreviewContainer.classList.remove('dragover');
                });
                uploadPreviewContainer.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadPreviewContainer.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) {
                        handleFile(e.dataTransfer.files[0]);
                    }
                });
            }

            // ç§»é™¤æ–‡ä»¶
            if (removeFileBtn) {
                removeFileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    uploadedFile = null;
                    if (fileInput) fileInput.value = '';
                    if (uploadState) uploadState.classList.remove('hidden');
                    if (previewState) previewState.classList.add('hidden');
                    const previewContent = document.getElementById('previewContent');
                    if (previewContent) previewContent.innerHTML = '';
                    updatePrintButton();
                });
            }

            // æ‰“å°æŒ‰é’®
            if (printBtn) {
                printBtn.addEventListener('click', handlePrint);
            }

            // åˆ·æ–°æŒ‰é’®
            if (refreshFilesBtn) {
                refreshFilesBtn.addEventListener('click', loadFiles);
            }
            if (refreshQueueBtn) {
                refreshQueueBtn.addEventListener('click', () => {
                    loadJobs();
                    loadPrinterQueue();
                    loadPrinterTrayInfo();
                    loadPrinterInkInfo();
                });
            }

            // æ‰“å°æœºé€‰æ‹©å˜åŒ–
            const printerSelect = document.getElementById('printerSelect');
            if (printerSelect) {
                printerSelect.addEventListener('change', () => {
                    loadPrinterQueue();
                    loadPrinterTrayInfo();
                    loadPrinterInkInfo();
                });
            }

            // åˆå§‹åŒ–
            (async () => {
                // ç­‰å¾…æ‰“å°æœºåˆ—è¡¨åŠ è½½å®Œæˆ
                await loadPrinters();
                await loadJobs();
                await loadFiles();
                await detectPDFSupport();

                // æ‰“å°æœºåˆ—è¡¨åŠ è½½å®Œæˆåï¼ŒåŠ è½½æ‰“å°æœºä¿¡æ¯
                await loadPrinterQueue();
                await loadPrinterTrayInfo();
                await loadPrinterInkInfo();
            })();

            setInterval(loadJobs, 5000);
            setInterval(loadFiles, 10000);
            setInterval(loadPrinterQueue, 10000);
        });

        function detectPDFSupport() {
            pdfSupport = navigator.pdfViewerEnabled !== false;
        }

        async function handleFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', { method: 'POST', body: formData });
                const data = await response.json();

                if (data.success) {
                    uploadedFile = data;
                    document.getElementById('previewFileName').textContent = data.filename;
                    document.getElementById('previewFileSize').textContent = formatFileSize(file.size);
                    
                    const uploadState = document.getElementById('uploadState');
                    const previewState = document.getElementById('previewState');
                    if (uploadState) uploadState.classList.add('hidden');
                    if (previewState) previewState.classList.remove('hidden');
                    
                    updatePrintButton();
                    showToast('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
                    loadPreview(data.filename);
                } else {
                    showToast('ä¸Šä¼ å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                showToast('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadPreview(filename) {
            const previewContent = document.getElementById('previewContent');
            if (!previewContent) return;

            const ext = filename.split('.').pop().toLowerCase();

            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'].includes(ext)) {
                previewContent.innerHTML = `<img src="/api/preview/${encodeURIComponent(filename)}" class="w-full h-full object-contain" alt="é¢„è§ˆ">`;
            } else if (['pdf', 'doc', 'docx', 'ppt', 'pptx', 'xls', 'xlsx', 'rtf', 'txt'].includes(ext)) {
                // PDFå’Œæ–‡æ¡£ç±»å‹ä½¿ç”¨objectæ ‡ç­¾å†…åµŒæ˜¾ç¤º
                const previewUrl = `/api/preview/${encodeURIComponent(filename)}`;
                
                previewContent.innerHTML = `
                    <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-10">
                        <div class="text-gray-500 text-center">
                            <svg class="animate-spin h-8 w-8 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p>æ­£åœ¨åŠ è½½é¢„è§ˆ...</p>
                        </div>
                    </div>
                    <object id="pdfObject" 
                            data="${previewUrl}" 
                            type="application/pdf" 
                            class="w-full h-full border-0"
                            style="height: 400px; width: 100%;">
                        <div class="flex flex-col items-center justify-center h-full bg-gray-50 text-center px-4">
                            <svg class="h-12 w-12 mx-auto mb-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="mb-2 text-gray-700 font-medium">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå†…åµŒPDFé¢„è§ˆ</p>
                            <p class="mb-4 text-sm text-gray-500">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨æ–°æ ‡ç­¾é¡µæŸ¥çœ‹</p>
                            <a href="${previewUrl}" target="_blank" class="inline-flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€
                            </a>
                        </div>
                    </object>
                `;
                
                // å»¶è¿Ÿæ£€æµ‹åŠ è½½çŠ¶æ€
                setTimeout(() => {
                    const pdfObject = document.getElementById('pdfObject');
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    
                    if (!pdfObject || !loadingIndicator) return;
                    
                    let checkCount = 0;
                    const maxChecks = 30; // 15ç§’
                    
                    const checkLoaded = setInterval(() => {
                        checkCount++;
                        
                        // è·å–objectå…ƒç´ çš„æ ·å¼
                        const computedStyle = getComputedStyle(pdfObject);
                        const width = pdfObject.clientWidth;
                        const height = pdfObject.clientHeight;
                        
                        // å¦‚æœobjectæœ‰å¯è§çš„å°ºå¯¸ï¼Œè®¤ä¸ºåŠ è½½æˆåŠŸ
                        if (width > 0 && height > 0) {
                            clearInterval(checkLoaded);
                            loadingIndicator.classList.add('hidden');
                        }
                        
                        // è¶…æ—¶
                        if (checkCount >= maxChecks) {
                            clearInterval(checkLoaded);
                            loadingIndicator.classList.add('hidden');
                            console.error('PDFåŠ è½½è¶…æ—¶');
                        }
                    }, 500);
                }, 500);
            } else {
                previewContent.innerHTML = `<div class="flex items-center justify-center h-full text-gray-500">æš‚ä¸æ”¯æŒæ­¤æ–‡ä»¶æ ¼å¼é¢„è§ˆ</div>`;
            }
        }

        async function handlePrint() {
            const btn = document.getElementById('printBtn');
            if (!btn) return;

            if (!uploadedFile) {
                showToast('è¯·å…ˆä¸Šä¼ æ–‡ä»¶', 'error');
                return;
            }

            const printerName = document.getElementById('printerSelect').value;
            if (!printerName) {
                showToast('è¯·é€‰æ‹©æ‰“å°æœº', 'error');
                return;
            }

            // è·å–æ‰“å°è®¾ç½®
            const colorMode = document.querySelector('input[name="colorMode"]:checked');
            const duplex = document.querySelector('input[name="duplex"]:checked');
            const orientation = document.querySelector('input[name="orientation"]:checked');
            const paperSize = document.getElementById('paperSize');
            const paperType = document.getElementById('paperType');
            const copies = document.getElementById('copies');
            const pageRange = document.getElementById('pageRange');

            if (!colorMode) {
                console.error('æœªé€‰æ‹©è‰²å½©æ¨¡å¼');
                showToast('è¯·é€‰æ‹©è‰²å½©æ¨¡å¼', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';

            try {
                const response = await fetch('/api/print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        filepath: uploadedFile.filepath,
                        printer: printerName,
                        color_mode: colorMode.value,
                        duplex: duplex ? duplex.value : 'one-sided',
                        orientation: orientation ? orientation.value : 'portrait',
                        paper_size: paperSize ? paperSize.value : 'A4',
                        paper_type: paperType ? paperType.value : 'plain',
                        copies: parseInt(copies.value) || 1,
                        page_range: pageRange ? pageRange.value.trim() : null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('æ‰“å°ä»»åŠ¡æäº¤æˆåŠŸ', 'success');
                    // æ˜¾ç¤ºæ‰“å°å‚æ•°è¯¦æƒ…
                    if (data.job) {
                        showPrintParams(data.job);
                    }
                    loadJobs();
                    resetForm();
                } else {
                    showToast('æäº¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('æ‰“å°é”™è¯¯:', error);
                showToast('æäº¤å¤±è´¥: ' + error.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ–¨ï¸ æäº¤æ‰“å°';
                }
            }
        }

        function resetForm() {
            uploadedFile = null;
            const fileInput = document.getElementById('fileInput');
            const uploadState = document.getElementById('uploadState');
            const previewState = document.getElementById('previewState');
            const previewContent = document.getElementById('previewContent');
            
            if (fileInput) fileInput.value = '';
            if (uploadState) uploadState.classList.remove('hidden');
            if (previewState) previewState.classList.add('hidden');
            if (previewContent) previewContent.innerHTML = '';
            
            const pageRange = document.getElementById('pageRange');
            if (pageRange) pageRange.value = '';
            
            updatePrintButton();

            // éšè—æ‰“å°å‚æ•°è¯¦æƒ…
            const printParamsSection = document.getElementById('printParamsSection');
            if (printParamsSection) {
                printParamsSection.classList.add('hidden');
            }
        }

        function showPrintParams(job) {
            const section = document.getElementById('printParamsSection');
            const content = document.getElementById('printParamsContent');
            
            if (!section || !content) return;

            section.classList.remove('hidden');
            
            const html = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">æ–‡ä»¶å:</span>
                        <span class="font-medium text-gray-800">${job.filename}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">æ‰“å°æœº:</span>
                        <span class="text-gray-800">${job.printer}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">è‰²å½©æ¨¡å¼:</span>
                        <span class="text-gray-800">${getColorModeText(job.color_mode)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">åŒé¢æ‰“å°:</span>
                        <span class="text-gray-800">${getDuplexText(job.duplex)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">æ‰“å°æ–¹å‘:</span>
                        <span class="text-gray-800">${getOrientationText(job.orientation)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">çº¸å¼ å¤§å°:</span>
                        <span class="text-gray-800">${getPaperSizeText(job.paper_size)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">çº¸å¼ æè´¨:</span>
                        <span class="text-gray-800">${getPaperTypeText(job.paper_type)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">æ‰“å°ä»½æ•°:</span>
                        <span class="text-gray-800">${job.copies}</span>
                    </div>
                    ${job.page_range ? `
                    <div class="flex justify-between">
                        <span class="text-gray-600">é¡µé¢èŒƒå›´:</span>
                        <span class="text-gray-800">${job.page_range}</span>
                    </div>
                    ` : ''}
                    <div class="flex justify-between">
                        <span class="text-gray-600">ä»»åŠ¡çŠ¶æ€:</span>
                        <span class="px-2 py-1 rounded-full text-xs ${getStatusColor(job.status)}">${getStatusText(job.status)}</span>
                    </div>
                    ${job.cups_job_id ? `
                    <div class="flex justify-between">
                        <span class="text-gray-600">CUPSä»»åŠ¡ID:</span>
                        <span class="text-gray-800 font-mono text-xs">${job.cups_job_id}</span>
                    </div>
                    ` : ''}
                    ${job.message ? `
                    <div class="mt-2 pt-2 border-t border-blue-200">
                        <span class="text-gray-600">æ¶ˆæ¯:</span>
                        <p class="text-gray-800 mt-1 text-sm">${job.message}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            content.innerHTML = html;
        }

        async function loadPrinters() {
            try {
                const response = await fetch('/api/printers');
                const data = await response.json();
                const select = document.getElementById('printerSelect');
                if (!select) return;

                select.innerHTML = '';
                if (data.printers && data.printers.length > 0) {
                    data.printers.forEach(printer => {
                        const option = document.createElement('option');
                        option.value = printer.name;
                        option.textContent = `${printer.name} (${printer.status})`;
                        select.appendChild(option);
                    });

                    // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€å°æ‰“å°æœº
                    select.selectedIndex = 0;
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'æœªæ£€æµ‹åˆ°æ‰“å°æœº';
                    select.appendChild(option);
                }
                updatePrintButton();
            } catch (error) {
                console.error('åŠ è½½æ‰“å°æœºå¤±è´¥:', error);
            }
        }

        async function loadPrinterQueue() {
            const printerSelect = document.getElementById('printerSelect');
            const printerQueueInfo = document.getElementById('printerQueueInfo');
            
            if (!printerSelect || !printerQueueInfo) return;
            
            const selectedPrinter = printerSelect.value;
            if (!selectedPrinter) {
                printerQueueInfo.innerHTML = '<p class="text-gray-500 text-center">è¯·å…ˆé€‰æ‹©æ‰“å°æœº</p>';
                return;
            }
            
            try {
                const response = await fetch(`/api/printer-queue/${encodeURIComponent(selectedPrinter)}`);
                const data = await response.json();
                
                if (data.status === 'error') {
                    printerQueueInfo.innerHTML = `
                        <div class="flex items-center gap-2 text-red-500">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>è·å–é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥</span>
                        </div>
                    `;
                    return;
                }
                
                const statusColors = {
                    'idle': 'text-green-600',
                    'printing': 'text-blue-600',
                    'disabled': 'text-red-600',
                    'unknown': 'text-gray-600'
                };
                const statusText = {
                    'idle': 'ç©ºé—²',
                    'printing': 'æ­£åœ¨æ‰“å°',
                    'disabled': 'å·²ç¦ç”¨',
                    'unknown': 'æœªçŸ¥'
                };
                
                let queueHtml = '';
                if (data.queue && data.queue.length > 0) {
                    queueHtml = `
                        <div class="mt-3 space-y-2">
                            <div class="text-sm font-medium text-gray-700">é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ (${data.queue.length})ï¼š</div>
                            ${data.queue.map(job => `
                                <div class="bg-white border rounded-lg p-2 text-xs">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">ä»»åŠ¡ #${job.job_id}</span>
                                        <span class="text-gray-500">${formatFileSize(parseInt(job.size))}</span>
                                    </div>
                                    <div class="text-gray-600 truncate">${job.filename}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    queueHtml = `
                        <div class="mt-3 text-sm text-gray-500 text-center">
                            é˜Ÿåˆ—ä¸ºç©º
                        </div>
                    `;
                }
                
                printerQueueInfo.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                            </svg>
                            <span class="font-medium">çŠ¶æ€ï¼š</span>
                            <span class="${statusColors[data.status]}">${statusText[data.status] || data.status}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${data.queue_length || 0} ä¸ªä»»åŠ¡
                        </div>
                    </div>
                    ${queueHtml}
                `;
            } catch (error) {
                console.error('åŠ è½½æ‰“å°æœºé˜Ÿåˆ—å¤±è´¥:', error);
                printerQueueInfo.innerHTML = `
                    <div class="flex items-center gap-2 text-red-500">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span>åŠ è½½å¤±è´¥</span>
                    </div>
                `;
            }
        }

        async function loadPrinterTrayInfo() {
            const printerSelect = document.getElementById('printerSelect');
            const printerTrayInfo = document.getElementById('printerTrayInfo');

            if (!printerSelect || !printerTrayInfo) return;

            const selectedPrinter = printerSelect.value;
            if (!selectedPrinter) {
                printerTrayInfo.innerHTML = '<p class="text-gray-500 text-center">è¯·å…ˆé€‰æ‹©æ‰“å°æœº</p>';
                return;
            }

            try {
                const response = await fetch(`/api/printer-tray/${encodeURIComponent(selectedPrinter)}`);
                const data = await response.json();

                if (data.error) {
                    printerTrayInfo.innerHTML = `
                        <div class="flex items-center gap-2 text-red-500">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>è·å–çº¸ç›’ä¿¡æ¯å¤±è´¥</span>
                        </div>
                    `;
                    return;
                }

                // æ˜¾ç¤ºçº¸ç›’ä¿¡æ¯
                if (data.trays && data.trays.length > 0) {
                    const traysHtml = data.trays.map(tray => {
                        // æ ¹æ®çº¸å¼ ä½™é‡è®¾ç½®é¢œè‰²
                        let levelColor = 'text-green-600';
                        if (tray.paper_level === 'ä½' || tray.paper_level === 'Low') {
                            levelColor = 'text-yellow-600';
                        } else if (tray.paper_level === 'ç©º' || tray.paper_level === 'Empty') {
                            levelColor = 'text-red-600';
                        }

                        // æ ¹æ®çŠ¶æ€è®¾ç½®å›¾æ ‡
                        let statusIcon = '';
                        if (tray.status === 'æ­£å¸¸' || tray.status === 'OK') {
                            statusIcon = '<svg class="w-4 h-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                        } else if (tray.status === 'è­¦å‘Š' || tray.status === 'Warning') {
                            statusIcon = '<svg class="w-4 h-4 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
                        } else {
                            statusIcon = '<svg class="w-4 h-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                        }

                        return `
                            <div class="bg-white border rounded-lg p-3 mb-2">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                        </svg>
                                        <span class="font-medium">${tray.tray_name}</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        ${statusIcon}
                                        <span class="text-xs ${tray.status === 'æ­£å¸¸' || tray.status === 'OK' ? 'text-green-600' : 'text-red-600'}">${tray.status}</span>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-xs">
                                    <div>
                                        <div class="text-gray-500">çº¸å¼ å¤§å°</div>
                                        <div class="font-medium">${tray.paper_size}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500">çº¸å¼ ç±»å‹</div>
                                        <div class="font-medium">${tray.paper_type}</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-500">çº¸å¼ ä½™é‡</div>
                                        <div class="font-medium ${levelColor}">${tray.paper_level}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    printerTrayInfo.innerHTML = traysHtml;
                } else {
                    printerTrayInfo.innerHTML = `
                        <div class="text-sm text-gray-500 text-center">
                            æœªæ‰¾åˆ°çº¸ç›’ä¿¡æ¯
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½çº¸ç›’ä¿¡æ¯å¤±è´¥:', error);
                printerTrayInfo.innerHTML = `
                    <div class="flex items-center gap-2 text-red-500">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span>åŠ è½½å¤±è´¥</span>
                    </div>
                `;
            }
        }

        async function loadPrinterInkInfo() {
            const printerSelect = document.getElementById('printerSelect');
            const printerInkInfo = document.getElementById('printerInkInfo');

            if (!printerSelect || !printerInkInfo) return;

            const selectedPrinter = printerSelect.value;
            if (!selectedPrinter) {
                printerInkInfo.innerHTML = '<p class="text-gray-500 text-center">è¯·å…ˆé€‰æ‹©æ‰“å°æœº</p>';
                return;
            }

            try {
                const response = await fetch(`/api/printer-ink/${encodeURIComponent(selectedPrinter)}`);
                const data = await response.json();

                if (data.error) {
                    printerInkInfo.innerHTML = `
                        <div class="flex items-center gap-2 text-red-500">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>è·å–å¢¨ç›’ä¿¡æ¯å¤±è´¥</span>
                        </div>
                    `;
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®çš„å¢¨ç›’ä¿¡æ¯ï¼ˆéæ¨¡æ‹Ÿæ•°æ®ï¼‰
                const hasRealInkData = data.source && data.source.includes('çœŸå®æ‰“å°æœº') && data.cartridges && data.cartridges.length > 0;
                // åªè¦æœ‰homepage_urlä¸”ä¸æ˜¯çœŸå®IPPæ•°æ®ï¼Œå°±å¯ä»¥å°è¯•åŠ è½½åµŒå…¥ä¸»é¡µ
                const canLoadEmbed = data.homepage_url && !hasRealInkData;

                console.log('å¢¨ç›’ä¿¡æ¯æ•°æ®æº:', data.source);
                console.log('æ˜¯å¦æœ‰çœŸå®å¢¨ç›’æ•°æ®:', hasRealInkData);
                console.log('homepage_url:', data.homepage_url);
                console.log('canLoadEmbed:', canLoadEmbed);

                // å¦‚æœæœ‰çœŸå®å¢¨ç›’æ•°æ®ï¼Œç›´æ¥æ˜¾ç¤º
                if (hasRealInkData) {
                    console.log('æ˜¾ç¤ºçœŸå®å¢¨ç›’æ•°æ®');
                    displayInkCartridges(data, printerInkInfo, false);
                    return;
                }

                // å¦‚æœæœ‰ä¸»é¡µURLä¸”æ²¡æœ‰çœŸå®æ•°æ®ï¼ŒåŠ è½½åµŒå…¥ä¸»é¡µ
                if (canLoadEmbed) {
                    console.log('å°è¯•åŠ è½½æ‰“å°æœºä¸»é¡µ:', data.homepage_url);
                    try {
                        const embedResponse = await fetch(`/api/printer-embed/${encodeURIComponent(selectedPrinter)}`);
                        const embedData = await embedResponse.json();

                        console.log('åµŒå…¥ä¸»é¡µå“åº”:', embedData);

                        if (embedData.embed_available) {
                            displayEmbeddedHomepage(embedData, data, printerInkInfo);
                            return;
                        } else {
                            console.warn('åµŒå…¥ä¸»é¡µä¸å¯ç”¨:', embedData.note || embedData.error);
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ‰“å°æœºä¸»é¡µå¤±è´¥:', error);
                    }
                }

                // å¦‚æœåµŒå…¥ä¹Ÿå¤±è´¥ï¼Œæ˜¾ç¤ºæ ‡å‡†å¢¨ç›’ä¿¡æ¯ï¼ˆå¯èƒ½æ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼‰
                displayInkCartridges(data, printerInkInfo, canLoadEmbed);

            } catch (error) {
                console.error('åŠ è½½å¢¨ç›’ä¿¡æ¯å¤±è´¥:', error);
                printerInkInfo.innerHTML = `
                    <div class="flex items-center gap-2 text-red-500">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <span>åŠ è½½å¤±è´¥</span>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºå¢¨ç›’åˆ—è¡¨ï¼ˆæ ‡å‡†æ˜¾ç¤ºï¼‰
        function displayInkCartridges(data, container, canLoadHomepage) {
            if (data.cartridges && data.cartridges.length > 0) {
                const cartridgesHtml = data.cartridges.map(cartridge => {
                    // æ ¹æ®å¢¨ç›’é¢œè‰²è®¾ç½®é¢œè‰²
                    let colorClass = '';
                    let colorHex = '';
                    switch(cartridge.color) {
                        case 'black':
                            colorClass = 'bg-gray-800';
                            colorHex = '#1f2937';
                            break;
                        case 'cyan':
                            colorClass = 'bg-cyan-500';
                            colorHex = '#06b6d4';
                            break;
                        case 'magenta':
                            colorClass = 'bg-pink-500';
                            colorHex = '#ec4899';
                            break;
                        case 'yellow':
                            colorClass = 'bg-yellow-500';
                            colorHex = '#eab308';
                            break;
                        case 'color':
                            colorClass = 'bg-gradient-to-r from-cyan-500 via-pink-500 to-yellow-500';
                            colorHex = 'linear-gradient(90deg, #06b6d4, #ec4899, #eab308)';
                            break;
                        default:
                            colorClass = 'bg-gray-500';
                            colorHex = '#6b7280';
                    }

                    // æ ¹æ®ä½™é‡è®¾ç½®è¿›åº¦æ¡é¢œè‰²
                    let progressColor = 'bg-green-500';
                    if (cartridge.level < 20) {
                        progressColor = 'bg-red-500';
                    } else if (cartridge.level < 50) {
                        progressColor = 'bg-yellow-500';
                    }

                    // æ ¹æ®çŠ¶æ€è®¾ç½®å›¾æ ‡
                    let statusIcon = '';
                    if (cartridge.status === 'æ­£å¸¸' || cartridge.status === 'OK') {
                        statusIcon = '<svg class="w-3 h-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                    } else if (cartridge.status === 'è­¦å‘Š' || cartridge.status === 'Warning') {
                        statusIcon = '<svg class="w-3 h-3 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
                    } else {
                        statusIcon = '<svg class="w-3 h-3 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                    }

                    return `
                        <div class="bg-white border rounded-lg p-3 mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <div class="w-4 h-4 rounded ${colorClass}"></div>
                                    <span class="font-medium">${cartridge.color_name}</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    ${statusIcon}
                                    <span class="text-xs ${cartridge.status === 'æ­£å¸¸' || cartridge.status === 'OK' ? 'text-green-600' : 'text-red-600'}">${cartridge.status}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-600 w-8">${cartridge.level}%</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div class="${progressColor} h-2 rounded-full transition-all" style="width: ${cartridge.level}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // æ·»åŠ æ•°æ®æ¥æºè¯´æ˜
                let sourceNote = '';
                if (data.note) {
                    sourceNote = `<div class="text-xs text-gray-500 mt-2 text-center">${data.note}</div>`;
                }

                container.innerHTML = `
                    <div class="space-y-2">
                        ${cartridgesHtml}
                    </div>
                    ${sourceNote}
                `;
            } else {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 text-center">
                        æœªæ‰¾åˆ°å¢¨ç›’ä¿¡æ¯
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºåµŒå…¥çš„æ‰“å°æœºä¸»é¡µ
        function displayEmbeddedHomepage(embedData, inkData, container) {
            const homepageUrl = embedData.homepage_url;
            console.log('åµŒå…¥ä¸»é¡µæ•°æ®:', embedData);
            console.log('method:', embedData.method);
            console.log('cache_file:', embedData.cache_file);

            let iframeContent = '';

            // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜æ–‡ä»¶ï¼ˆè¿™æ ·ç›¸å¯¹è·¯å¾„èƒ½æ­£ç¡®è§£æï¼‰
            if (embedData.method === 'direct_embed' && embedData.cache_file) {
                // ä»ç¼“å­˜æ–‡ä»¶è·¯å¾„æå–æ–‡ä»¶å
                const cacheFileName = embedData.cache_file.split('/').pop();
                const cacheUrl = `/printer-cache/${cacheFileName}`;

                console.log('ä½¿ç”¨ç¼“å­˜æ–‡ä»¶:', cacheUrl);

                iframeContent = `
                    <iframe
                        src="${cacheUrl}"
                        class="w-full h-64 border rounded-lg"
                        sandbox="allow-same-origin allow-scripts"
                    ></iframe>
                `;
            } else if (embedData.method === 'direct_embed' && embedData.html_content) {
                // å¤‡é€‰æ–¹æ¡ˆï¼šç›´æ¥åµŒå…¥HTMLå†…å®¹ï¼ˆä½†ç›¸å¯¹è·¯å¾„å¯èƒ½å¤±æ•ˆï¼‰
                console.warn('ä½¿ç”¨srcdocåµŒå…¥ï¼Œç›¸å¯¹è·¯å¾„å¯èƒ½æ— æ³•åŠ è½½');
                iframeContent = `
                    <iframe
                        srcdoc="${embedData.html_content.replace(/"/g, '&quot;')}"
                        class="w-full h-64 border rounded-lg"
                        sandbox="allow-same-origin allow-scripts"
                    ></iframe>
                `;
            } else {
                // é”™è¯¯æƒ…å†µï¼šä¸åº”è¯¥èµ°åˆ°è¿™é‡Œ
                console.error('é”™è¯¯ï¼šembedData.methodä¸æ˜¯direct_embedï¼Œä¸”æ²¡æœ‰cache_file');
                console.error('embedData:', embedData);
                iframeContent = `
                    <div class="p-4 border rounded-lg bg-red-50 text-red-700">
                        <p>é”™è¯¯ï¼šæ— æ³•åŠ è½½æ‰“å°æœºä¸»é¡µ</p>
                        <p class="text-sm">æ–¹æ³•: ${embedData.method || 'æœªçŸ¥'}</p>
                        <p class="text-sm">é”™è¯¯ä¿¡æ¯: ${embedData.note || embedData.error || 'æ— '}</p>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">æ‰“å°æœºä¸»é¡µ</span>
                        <button
                            onclick="loadPrinterInkInfo()"
                            class="text-xs text-blue-600 hover:text-blue-800"
                            title="åˆ·æ–°"
                        >
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                    ${iframeContent}
                    <div class="text-xs text-gray-500 mt-2 text-center">
                        å¢¨ç›’ä¿¡æ¯æ¥è‡ªæ‰“å°æœºä¸»é¡µ
                        <a href="${homepageUrl}" target="_blank" class="text-blue-600 hover:underline">åœ¨æ–°çª—å£æ‰“å¼€</a>
                    </div>
                </div>
            `;
        }

        async function loadFiles() {
            console.log('åŠ è½½æ–‡ä»¶åˆ—è¡¨');
            try {
                const response = await fetch('/api/files');
                const data = await response.json();
                const container = document.getElementById('filesList');
                if (!container) return;

                if (!data.files || data.files.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">æš‚æ— å·²ä¸Šä¼ æ–‡ä»¶</p>';
                    return;
                }

                container.innerHTML = data.files.map(file => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-800 truncate">${file.filename}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="selectFile('${file.filename}')" class="text-xs text-blue-500 hover:text-blue-700">é€‰æ‹©</button>
                            <button onclick="deleteFile('${file.filename}')" class="text-xs text-red-500 hover:text-red-700">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function selectFile(filename) {
            try {
                const response = await fetch('/api/files');
                const data = await response.json();
                const file = data.files.find(f => f.filename === filename);
                if (file) {
                    uploadedFile = { filename: file.filename, filepath: file.filepath };
                    document.getElementById('previewFileName').textContent = file.filename;
                    document.getElementById('previewFileSize').textContent = 'å·²ä¸Šä¼ æ–‡ä»¶';
                    
                    const uploadState = document.getElementById('uploadState');
                    const previewState = document.getElementById('previewState');
                    if (uploadState) uploadState.classList.add('hidden');
                    if (previewState) previewState.classList.remove('hidden');
                    
                    loadPreview(file.filename);
                    updatePrintButton();
                    showToast('å·²é€‰æ‹©æ–‡ä»¶', 'success');
                }
            } catch (error) {
                console.error('é€‰æ‹©æ–‡ä»¶å¤±è´¥:', error);
            }
        }

        async function deleteFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/files/${filename}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
                    loadFiles();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs');
                const data = await response.json();
                jobs = data.jobs || [];
                const container = document.getElementById('jobsList');
                if (!container) return;

                if (jobs.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">æš‚æ— æ‰“å°ä»»åŠ¡</p>';
                    return;
                }

                container.innerHTML = jobs.map(job => `
                    <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-2 cursor-pointer" onclick="toggleJobDetails('${job.id}')">
                            <div class="flex-1">
                                <p class="font-medium text-sm text-gray-800">${job.filename}</p>
                                <p class="text-xs text-gray-500">${job.printer} | ${job.copies}ä»½</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(job.status)}">${getStatusText(job.status)}</span>
                        </div>

                        <!-- æ‰“å°å‚æ•°è¯¦æƒ… -->
                        <div id="job-details-${job.id}" class="hidden mt-3 pt-3 border-t border-gray-200">
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <div class="flex">
                                    <span class="text-gray-500 w-20">è‰²å½©æ¨¡å¼:</span>
                                    <span class="text-gray-800">${getColorModeText(job.color_mode)}</span>
                                </div>
                                <div class="flex">
                                    <span class="text-gray-500 w-20">åŒé¢æ‰“å°:</span>
                                    <span class="text-gray-800">${getDuplexText(job.duplex)}</span>
                                </div>
                                <div class="flex">
                                    <span class="text-gray-500 w-20">æ‰“å°æ–¹å‘:</span>
                                    <span class="text-gray-800">${getOrientationText(job.orientation)}</span>
                                </div>
                                <div class="flex">
                                    <span class="text-gray-500 w-20">çº¸å¼ å¤§å°:</span>
                                    <span class="text-gray-800">${getPaperSizeText(job.paper_size)}</span>
                                </div>
                                <div class="flex">
                                    <span class="text-gray-500 w-20">çº¸å¼ æè´¨:</span>
                                    <span class="text-gray-800">${getPaperTypeText(job.paper_type)}</span>
                                </div>
                                ${job.page_range ? `
                                <div class="flex col-span-2">
                                    <span class="text-gray-500 w-20">é¡µé¢èŒƒå›´:</span>
                                    <span class="text-gray-800">${job.page_range}</span>
                                </div>
                                ` : ''}
                            </div>
                            <div class="mt-2 text-xs text-gray-400">
                                ä»»åŠ¡ID: ${job.id.substring(0, 8)}...
                                ${job.cups_job_id ? ` | CUPSä»»åŠ¡ID: ${job.cups_job_id}` : ''}
                            </div>
                            ${job.message ? `
                            <div class="mt-2 p-2 bg-gray-50 rounded text-xs text-gray-600">
                                <span class="font-medium">æ¶ˆæ¯:</span> ${job.message}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        function getStatusColor(status) {
            const colors = {
                'submitted': 'bg-blue-100 text-blue-800',
                'processing': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-green-100 text-green-800',
                'failed': 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusText(status) {
            const texts = {
                'submitted': 'å·²æäº¤',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            return texts[status] || status;
        }

        function getColorModeText(mode) {
            const texts = {
                'color': 'å½©è‰²',
                'mono': 'é»‘ç™½'
            };
            return texts[mode] || mode;
        }

        function getDuplexText(duplex) {
            const texts = {
                'one-sided': 'å•é¢æ‰“å°',
                'two-sided-long-edge': 'åŒé¢æ‰“å°ï¼ˆé•¿è¾¹è£…è®¢ï¼‰',
                'two-sided-short-edge': 'åŒé¢æ‰“å°ï¼ˆçŸ­è¾¹è£…è®¢ï¼‰'
            };
            return texts[duplex] || duplex;
        }

        function getOrientationText(orientation) {
            const texts = {
                'portrait': 'çºµå‘',
                'landscape': 'æ¨ªå‘'
            };
            return texts[orientation] || orientation;
        }

        function getPaperSizeText(size) {
            const texts = {
                'A4': 'A4 (210Ã—297mm)',
                'A3': 'A3 (297Ã—420mm)',
                'A2': 'A2 (420Ã—594mm)',
                'A1': 'A1 (594Ã—841mm)',
                '5inch': '5å¯¸ (89Ã—127mm)',
                '6inch': '6å¯¸ (102Ã—152mm)',
                '7inch': '7å¯¸ (127Ã—178mm)',
                '8inch': '8å¯¸ (152Ã—203mm)',
                '10inch': '10å¯¸ (203Ã—254mm)'
            };
            return texts[size] || size;
        }

        function getPaperTypeText(type) {
            const texts = {
                'plain': 'æ™®é€šçº¸',
                'glossy': 'å…‰é¢ç…§ç‰‡çº¸'
            };
            return texts[type] || type;
        }

        function toggleJobDetails(jobId) {
            const detailsDiv = document.getElementById(`job-details-${jobId}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
            }
        }

        function updatePrintButton() {
            const btn = document.getElementById('printBtn');
            const printer = document.getElementById('printerSelect')?.value;
            if (btn) {
                btn.disabled = !uploadedFile || !printer;
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.textContent = message;
            toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg';
            
            if (type === 'success') {
                toast.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-red-500', 'text-white');
            } else {
                toast.classList.add('bg-gray-800', 'text-white');
            }
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
